document.addEventListener("DOMContentLoaded",async function(){const e="https://simprosys.frappe.cloud",n="6fe867e53ad492c",l="03189fe2e131e54",o=document.getElementById("plugin_or_app_related_queries"),s=document.getElementById("platformSelect"),i=document.getElementById("appSelect"),f=s.nextElementSibling,y=i.nextElementSibling;function h(){s.style.display="none",i.style.display="none",y.style.display="none",f.style.display="none"}function g(){s.style.display="block",i.style.display="block",y.style.display="flex",f.style.display="flex"}function S(){Array.from(s.options).forEach((t,a)=>{a!==0&&(t.style.display="none")})}async function C(){try{const a=await(await fetch(`${e}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Platform"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${n}:${l}`}})).json();a.data&&(s.innerHTML+=a.data.map(d=>`<option value="${d.name}" data-display-name="${d.post_category_name}">${d.post_category_name}</option>`).join(""),S())}catch(t){console.error("Error fetching platforms:",t)}}async function r(t){if(i.innerHTML='<option value="" disabled selected>Select App</option>',!!t)try{const d=await(await fetch(`${e}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Category"],["parent_simprosys_post_category","=","${t}"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${n}:${l}`}})).json();d.data&&(i.innerHTML+=d.data.map(c=>`<option value="${c.name}" data-display-name="${c.post_category_name}">${c.post_category_name}</option>`).join(""))}catch(a){console.error("Error fetching apps:",a)}}o.addEventListener("change",function(){const t=this.value;t==="Plugin and App related query"?g():h(),Array.from(s.options).forEach((a,d)=>{d!==0&&(a.style.display=t?"block":"none")})}),s.addEventListener("change",t=>{r(t.target.value),s.querySelector("option[value='']").disabled=!0}),i.addEventListener("change",()=>{i.querySelector("option[value='']").disabled=!0}),C(),h()});const V=document.getElementById("name1"),q=document.getElementById("company_name"),F=document.getElementById("email");let m=document.getElementById("name1_valid"),u=document.getElementById("company_valid"),p=document.getElementById("email_valid");const D=/^(?=(?:[^A-Za-z]*[A-Za-z]){2})(?![^\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,]*[\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,])\S+(?: \S+){0,2}$/,Z=/^(?=(?:[^A-Za-z]*[A-Za-z]){2})(?![^A-Za-z0-9 ]*$)[A-Za-z0-9]+(?: [A-Za-z0-9]+){0,2}$/,N=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,U=/[a-zA-Z0-9-]+(\.[a-zA-Z]{2,})+([\/\w.-]*)*\/?/;let B=!1,$=!1,P=!1,j=!1,I=!1,E=!1,v=!1,A=!0;V.addEventListener("input",()=>{const e=V.value.trim();e===""?(m.classList.remove("hidden"),m.textContent="Please fill out this field"):D.test(e)?(m.classList.add("hidden"),m.textContent=""):(m.classList.remove("hidden"),m.textContent="Please Enter Valid name")});q.addEventListener("input",()=>{const e=q.value.trim();e===""?(u.classList.remove("hidden"),u.textContent="Please fill out this field"):Z.test(e)?(u.classList.add("hidden"),u.textContent=""):(u.classList.remove("hidden"),u.textContent="Please Enter Valid Company name")});F.addEventListener("input",()=>{const e=F.value.trim();e===""?(p.classList.remove("hidden"),p.textContent="Please fill out this field"):N.test(e)?(p.classList.add("hidden"),p.textContent=""):(p.classList.remove("hidden"),p.textContent="Please Enter Valid Email")});const w=document.getElementById("store_url"),L=document.getElementById("store_url_valid");w.addEventListener("input",function(){const e=w.value.trim();e===""||U.test(e)?L.classList.add("hidden"):(L.classList.remove("hidden"),A=!1)});const x=document.getElementById("plugin_or_app_related_queries"),M=document.getElementById("platformSelect"),R=document.getElementById("appSelect"),z=document.getElementById("plugin_id_valid"),T=document.getElementById("platform_id_valid"),b=document.getElementById("app_id_valid");R.addEventListener("input",()=>{x.value==="Plugin and App related query"&&R.value===""?(b.classList.remove("hidden"),v=!1):(b.classList.add("hidden"),v=!0)});M.addEventListener("input",()=>{x.value==="Plugin and App related query"&&M.value===""?(T.classList.remove("hidden"),E=!1):(T.classList.add("hidden"),E=!0)});x.addEventListener("input",()=>{x.value===""?(z.classList.remove("hidden"),I=!1):(z.classList.add("hidden"),I=!0)});function H(){let e=V.value.trim(),n=q.value.trim(),l=F.value.trim();if(e===""?(m.classList.remove("hidden"),m.textContent="Please fill out this field",B=!1):D.test(e)?(m.classList.add("hidden"),m.textContent="",B=!0):(m.classList.remove("hidden"),m.textContent="Please Enter Valid name",B=!1),n===""?(u.classList.remove("hidden"),u.textContent="Please fill out this field",$=!1):Z.test(n)?(u.classList.add("hidden"),u.textContent="",$=!0):(u.classList.remove("hidden"),u.textContent="Please Enter Valid Company name",$=!1),l===""?(p.classList.remove("hidden"),p.textContent="Please fill out this field",P=!1):N.test(l)?(p.classList.add("hidden"),p.textContent="",P=!0):(p.classList.remove("hidden"),p.textContent="Please Enter Valid Email",P=!1),x.value===""?(z.classList.remove("hidden"),I=!1):(z.classList.add("hidden"),I=!0),x.value==="Plugin and App related query"?(M.value===""?(T.classList.remove("hidden"),E=!1):(T.classList.add("hidden"),E=!0),R.value===""?(b.classList.remove("hidden"),v=!1):(b.classList.add("hidden"),v=!0)):(E=!0,v=!0),w!==null){const o=w.value.trim();o===""||U.test(o)?(L.classList.add("hidden"),A=!0):(L.classList.remove("hidden"),A=!1)}return B&&$&&P&&I&&E&&v&&k&&A&&(j=!0),j}let k=!0,_=[];document.getElementById("attach_file").addEventListener("change",function(e){let n=e.target.files,l=document.getElementById("file_error"),o=document.getElementById("file_list"),s=document.getElementById("attach_file_text"),i=["jpeg","jpg","png","pdf","txt","zip","zzip","mp4","docx","csv","webp"],f=0,y=[],h=[];o.innerHTML="";for(let t=0;t<n.length;t++){let a=n[t].name.split(".").pop().toLowerCase();i.includes(a)?_.push(n[t]):h.push(n[t].name)}if(h.length>0){l.textContent=`Invalid file types: ${h.join(", ")}. Allowed formats: ${i.join(", ")}`,e.target.value="";return}else l.textContent="";_.forEach(t=>{f+=t.size,y.push(t.name)});let g=25;if(f/(1024*1024)>g){l.textContent=`Total file size must be under ${g}MB.`,e.target.value="",_=[],k=!1,s.textContent="Attach File";return}else l.textContent="",k=!0;function C(t){_.splice(t,1),r()}function r(){o.innerHTML="",_.forEach((t,a)=>{let d=document.createElement("div");d.classList.add("file-item"),d.textContent=t.name;let c=document.createElement("button");c.textContent="x",c.classList.add("cancel-btn"),c.addEventListener("click",function(){C(a)}),d.appendChild(c),o.appendChild(d)})}r()});document.getElementById("cancel_file").addEventListener("click",function(){let e=document.getElementById("attach_file"),n=document.getElementById("file_list");e.value="",n.innerHTML="",document.getElementById("file_error").textContent="",_=[],k=!0});document.getElementById("form_id");function K(e){const n=document.getElementById("success-popup"),l=document.getElementById("form_id");let o=document.getElementById("cancel_file");e.ok?(n.classList.remove("hidden"),console.log("Ticket created successfully."),document.getElementById("closePopup").addEventListener("click",()=>{n.classList.add("hidden"),o.classList.add("hidden"),document.getElementById("attach_file_text").textContent="Attach File",document.getElementById("file_list").innerHTML="",l.reset(),document.querySelector("#attach_file").value=""}),setTimeout(()=>{n.classList.add("hidden"),o.classList.add("hidden"),document.getElementById("attach_file_text").textContent="Attach File",document.getElementById("file_list").innerHTML="",l.reset(),document.querySelector("#attach_file").value=""},3e3),e.status===100?(n.classList.remove("hidden"),console.log("Document created successfully.")):console.error("Failed to create document.")):console.error("Failed to create document.")}async function O(e){if(e.preventDefault(),H()){const l="https://simprosys.frappe.cloud",o="6fe867e53ad492c",s="03189fe2e131e54",i=document.querySelector("#attach_file");console.log("Called");let f=[];if(i.files.length>0){const r=[...i.files].map(async t=>{const a=new FormData;a.append("file",t),a.append("is_private",0);const d=await fetch(`${l}/api/method/upload_file`,{method:"POST",headers:{Authorization:`token ${o}:${s}`},body:a}),c=await d.json();if(d.ok&&c.message.file_url)return c.message.file_url;throw new Error("File upload failed: "+(c.message?.error||"Unknown error"))});try{f=await Promise.all(r)}catch(t){console.error("Upload error:",t),alert("File upload failed: "+t.message);return}}const y=document.querySelector("#platformSelect"),h=document.querySelector("#appSelect"),g=y.options[y.selectedIndex],S=h.options[h.selectedIndex],C={name1:document.querySelector("#name1").value,company_name:document.querySelector("#company_name").value,store_url:document.querySelector("#store_url").value,email:document.querySelector("#email").value,plugin_or_app_related_queries:document.querySelector("#plugin_or_app_related_queries").value,platform:g?g.getAttribute("data-display-name"):"",app:S?S.getAttribute("data-display-name"):"",additional_details:document.querySelector("#message").value};try{const r=await fetch(`${l}/api/resource/Support%20Simprosys%20Ticket`,{method:"POST",headers:{Authorization:`token ${o}:${s}`,"Content-Type":"application/json"},body:JSON.stringify(C)}),t=await r.json();if(r.ok){let a=t.data.name;console.log("Ticket Name",a),K(r),await G(a,f),await J(a)}else alert("Error: "+t.error)}catch(r){console.error("Form submission error:",r),alert("Failed to submit ticket!")}}}async function G(e,n){const l="https://simprosys.frappe.cloud",o="6fe867e53ad492c",s="03189fe2e131e54";console.log(`
Ticket Name`,e),console.log(`
File URL`,n);for(let i of n){const f={file_url:i,attached_to_doctype:"Support Simprosys Ticket",attached_to_name:e};try{await fetch(`${l}/api/resource/File`,{method:"POST",headers:{Authorization:`token ${o}:${s}`,"Content-Type":"application/json"},body:JSON.stringify(f)})}catch(y){console.error("Attachment error:",y)}}}async function J(e){const n="https://simprosys.frappe.cloud",l="6fe867e53ad492c",o="03189fe2e131e54";console.log("Email Send");try{const s=await fetch(`${n}/api/method/support_simprosys.support_simprosys.api.send_support_ticket_email?docname=${e}`,{method:"GET",headers:{Authorization:`token ${l}:${o}`}});console.log("Email Response Status:",s.status);const i=await s.json();console.log("Email API response:",i)}catch(s){console.error("Email sending failed:",s)}console.log("Email successfully gone ")}window.submitTicket=O;
