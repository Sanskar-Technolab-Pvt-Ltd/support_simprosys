document.addEventListener("DOMContentLoaded",async function(){const e="https://simprosys.frappe.cloud",n="ba1e8c251c54878",a="c2aa3865b574c87",s=document.getElementById("plugin_or_app_related_queries"),l=document.getElementById("platformSelect"),o=document.getElementById("appSelect"),f=l.nextElementSibling,y=o.nextElementSibling;function h(){l.style.display="none",o.style.display="none",y.style.display="none",f.style.display="none"}function E(){l.style.display="block",o.style.display="block",y.style.display="flex",f.style.display="flex"}function B(){Array.from(l.options).forEach((t,d)=>{d!==0&&(t.style.display="none")})}async function p(){try{const d=await(await fetch(`${e}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Platform"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${n}:${a}`}})).json();d.data&&(l.innerHTML+=d.data.map(i=>`<option value="${i.name}" data-display-name="${i.post_category_name}">${i.post_category_name}</option>`).join(""),B())}catch(t){console.error("Error fetching platforms:",t)}}async function r(t){if(o.innerHTML='<option value="" disabled selected>Select App</option>',!!t)try{const i=await(await fetch(`${e}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Category"],["parent_simprosys_post_category","=","${t}"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${n}:${a}`}})).json();i.data&&(o.innerHTML+=i.data.map(g=>`<option value="${g.name}" data-display-name="${g.post_category_name}">${g.post_category_name}</option>`).join(""))}catch(d){console.error("Error fetching apps:",d)}}s.addEventListener("change",function(){const t=this.value;t==="Plugin and App related query"?E():h(),Array.from(l.options).forEach((d,i)=>{i!==0&&(d.style.display=t?"block":"none")})}),l.addEventListener("change",t=>{r(t.target.value),l.querySelector("option[value='']").disabled=!0}),o.addEventListener("change",()=>{o.querySelector("option[value='']").disabled=!0}),p(),h()});const z=document.getElementById("name1"),F=document.getElementById("company_name"),q=document.getElementById("email");let c=document.getElementById("name1_valid"),m=document.getElementById("company_valid"),u=document.getElementById("email_valid");const N=/^(?=(?:[^A-Za-z]*[A-Za-z]){2})(?![^\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,]*[\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,])\S+(?: \S+){0,2}$/,U=/^[A-Za-z0-9 ]+$/,K=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,Z=/[a-zA-Z0-9-]+(\.[a-zA-Z]{2,})+([\/\w.-]*)*\/?/;let A=!1,b=!1,P=!1,j=!1,I=!1,v=!1,L=!1,C=!0;z.addEventListener("input",()=>{const e=z.value.trim();e===""?(c.classList.remove("hidden"),c.textContent="Please fill out this field"):N.test(e)?(c.classList.add("hidden"),c.textContent=""):(c.classList.remove("hidden"),c.textContent="Please Enter Valid name")});F.addEventListener("input",()=>{const e=F.value.trim();e===""?(m.classList.remove("hidden"),m.textContent="Please fill out this field"):U.test(e)?(m.classList.add("hidden"),m.textContent=""):(m.classList.remove("hidden"),m.textContent="Please Enter Valid Company name")});q.addEventListener("input",()=>{const e=q.value.trim();e===""?(u.classList.remove("hidden"),u.textContent="Please fill out this field"):K.test(e)?(u.classList.add("hidden"),u.textContent=""):(u.classList.remove("hidden"),u.textContent="Please Enter Valid Email")});const $=document.getElementById("store_url"),x=document.getElementById("store_url_valid");$.addEventListener("input",function(){const e=$.value.trim();e===""||Z.test(e)?x.classList.add("hidden"):(x.classList.remove("hidden"),C=!1)});const S=document.getElementById("plugin_or_app_related_queries"),M=document.getElementById("platformSelect"),R=document.getElementById("appSelect"),w=document.getElementById("plugin_id_valid"),T=document.getElementById("platform_id_valid"),k=document.getElementById("app_id_valid");R.addEventListener("input",()=>{S.value==="Plugin and App related query"&&R.value===""?(k.classList.remove("hidden"),L=!1):(k.classList.add("hidden"),L=!0)});M.addEventListener("input",()=>{S.value==="Plugin and App related query"&&M.value===""?(T.classList.remove("hidden"),v=!1):(T.classList.add("hidden"),v=!0)});S.addEventListener("input",()=>{S.value===""?(w.classList.remove("hidden"),I=!1):(w.classList.add("hidden"),I=!0)});function H(){let e=z.value.trim(),n=F.value.trim(),a=q.value.trim();if(e===""?(c.classList.remove("hidden"),c.textContent="Please fill out this field",A=!1):N.test(e)?(c.classList.add("hidden"),c.textContent="",A=!0):(c.classList.remove("hidden"),c.textContent="Please Enter Valid name",A=!1),n===""?(m.classList.remove("hidden"),m.textContent="Please fill out this field",b=!1):U.test(n)?(m.classList.add("hidden"),m.textContent="",b=!0):(m.classList.remove("hidden"),m.textContent="Please Enter Valid Company name",b=!1),a===""?(u.classList.remove("hidden"),u.textContent="Please fill out this field",P=!1):K.test(a)?(u.classList.add("hidden"),u.textContent="",P=!0):(u.classList.remove("hidden"),u.textContent="Please Enter Valid Email",P=!1),S.value===""?(w.classList.remove("hidden"),I=!1):(w.classList.add("hidden"),I=!0),S.value==="Plugin and App related query"?(M.value===""?(T.classList.remove("hidden"),v=!1):(T.classList.add("hidden"),v=!0),R.value===""?(k.classList.remove("hidden"),L=!1):(k.classList.add("hidden"),L=!0)):(v=!0,L=!0),$!==null){const s=$.value.trim();s===""||Z.test(s)?(x.classList.add("hidden"),C=!0):(x.classList.remove("hidden"),C=!1)}return A&&b&&P&&I&&v&&L&&V&&C&&(j=!0),j}let V=!0,_=[];document.getElementById("attach_file").addEventListener("change",function(e){let n=e.target.files,a=document.getElementById("file_error"),s=document.getElementById("file_list"),l=document.getElementById("attach_file_text"),o=["jpeg","jpg","png","pdf","txt","zip","zzip","mp4","docx","csv","webp"],f=0,y=[],h=[];s.innerHTML="";for(let t=0;t<n.length;t++){let d=n[t].name.split(".").pop().toLowerCase();o.includes(d)?_.push(n[t]):h.push(n[t].name)}if(h.length>0){a.textContent=`Invalid file types: ${h.join(", ")}. Allowed formats: ${o.join(", ")}`,e.target.value="";return}else a.textContent="";_.forEach(t=>{f+=t.size,y.push(t.name)});let E=25;if(f/(1024*1024)>E){a.textContent=`Total file size must be under ${E}MB.`,e.target.value="",_=[],V=!1,l.textContent="Attach File";return}else a.textContent="",V=!0;function p(t){_.splice(t,1),r()}function r(){s.innerHTML="",_.forEach((t,d)=>{let i=document.createElement("div");i.classList.add("file-item"),i.textContent=t.name;let g=document.createElement("button");g.textContent="x",g.classList.add("cancel-btn"),g.addEventListener("click",function(){p(d)}),i.appendChild(g),s.appendChild(i)})}r()});document.getElementById("cancel_file").addEventListener("click",function(){let e=document.getElementById("attach_file"),n=document.getElementById("file_list");e.value="",n.innerHTML="",document.getElementById("file_error").textContent="",_=[],V=!0});document.getElementById("form_id");function O(e){const n=document.getElementById("success-popup"),a=document.getElementById("form_id");let s=document.getElementById("cancel_file");e.ok?(n.classList.remove("hidden"),console.log("Ticket created successfully."),document.getElementById("closePopup").addEventListener("click",()=>{n.classList.add("hidden"),s.classList.add("hidden"),document.getElementById("attach_file_text").textContent="Attach File",document.getElementById("file_list").innerHTML="",a.reset(),location.reload()}),setTimeout(()=>{n.classList.add("hidden"),s.classList.add("hidden"),document.getElementById("attach_file_text").textContent="Attach File",document.getElementById("file_list").value="",a.reset(),location.reload()},3e3),e.status===100?(n.classList.remove("hidden"),console.log("Document created successfully.")):console.error("Failed to create document.")):console.error("Failed to create document.")}function G(){document.getElementById("loader").classList.remove("hidden")}function D(){document.getElementById("loader").classList.add("hidden")}async function J(e){if(e.preventDefault(),H()){G();const a="https://simprosys.frappe.cloud",s="ba1e8c251c54878",l="c2aa3865b574c87";document.querySelector("#attach_file"),console.log("Called");let o=[];if(_.length>0){const p=_.map(async r=>{const t=new FormData;t.append("file",r),t.append("is_private",0);const d=await fetch(`${a}/api/method/upload_file`,{method:"POST",headers:{Authorization:`token ${s}:${l}`},body:t}),i=await d.json();if(d.ok&&i.message.file_url)return i.message.file_url;throw new Error("File upload failed: "+(i.message?.error||"Unknown error"))});try{o=await Promise.all(p)}catch(r){console.error("Upload error:",r),alert("File upload failed: "+r.message);return}}const f=document.querySelector("#platformSelect"),y=document.querySelector("#appSelect"),h=f.options[f.selectedIndex],E=y.options[y.selectedIndex],B={name1:document.querySelector("#name1").value,company_name:document.querySelector("#company_name").value,store_url:document.querySelector("#store_url").value,email:document.querySelector("#email").value,plugin_or_app_related_queries:document.querySelector("#plugin_or_app_related_queries").value,platform:h?h.getAttribute("data-display-name"):"",app:E?E.getAttribute("data-display-name"):"",additional_details:document.querySelector("#message").value};try{const p=await fetch(`${a}/api/resource/Support%20Simprosys%20Ticket`,{method:"POST",headers:{Authorization:`token ${s}:${l}`,"Content-Type":"application/json"},body:JSON.stringify(B)}),r=await p.json();if(p.ok){let t=r.data.name;console.log("Ticket Name",t),await Q(t,o),D(),O(p),await W(t)}else alert("Error: "+r.error)}catch(p){D(),console.error("Form submission error:",p),alert("Failed to submit ticket!")}}}async function Q(e,n){const a="https://simprosys.frappe.cloud",s="ba1e8c251c54878",l="c2aa3865b574c87";console.log(`
Ticket Name`,e),console.log(`
File URL`,n);for(let o of n){const f={file_url:o,attached_to_doctype:"Support Simprosys Ticket",attached_to_name:e};try{await fetch(`${a}/api/resource/File`,{method:"POST",headers:{Authorization:`token ${s}:${l}`,"Content-Type":"application/json"},body:JSON.stringify(f)})}catch(y){console.error("Attachment error:",y)}}}async function W(e){const n="https://simprosys.frappe.cloud",a="ba1e8c251c54878",s="c2aa3865b574c87";console.log("Email Send");try{const l=await fetch(`${n}/api/method/support_simprosys.support_simprosys.api.send_support_ticket_email?docname=${e}`,{method:"GET",headers:{Authorization:`token ${a}:${s}`}});console.log("Email Response Status:",l.status);const o=await l.json();console.log("Email API response:",o)}catch(l){console.error("Email sending failed:",l)}console.log("Email successfully gone ")}window.submitTicket=J;
