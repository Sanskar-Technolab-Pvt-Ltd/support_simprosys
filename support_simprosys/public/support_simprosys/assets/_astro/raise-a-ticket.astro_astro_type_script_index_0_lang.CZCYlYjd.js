document.addEventListener("DOMContentLoaded",async function(){const t="https://support.simprosys.com",a="c58178baf306cfa",s="51c0b9c774c0488",o=document.getElementById("plugin_or_app_related_queries"),n=document.getElementById("platformSelect"),i=document.getElementById("appSelect"),f=n.nextElementSibling,y=i.nextElementSibling;function h(){n.style.display="none",i.style.display="none",y.style.display="none",f.style.display="none"}function _(){n.style.display="block",i.style.display="block",y.style.display="flex",f.style.display="flex"}function I(){Array.from(n.options).forEach((e,d)=>{d!==0&&(e.style.display="none")})}async function u(){try{const d=await(await fetch(`${t}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Platform"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${a}:${s}`}})).json();d.data&&(n.innerHTML+=d.data.map(l=>`<option value="${l.name}" data-display-name="${l.post_category_name}">${l.post_category_name}</option>`).join(""),I())}catch(e){console.error("Error fetching platforms:",e)}}async function r(e){if(i.innerHTML='<option value="" disabled selected>Select App</option>',!!e)try{const l=await(await fetch(`${t}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Category"],["parent_simprosys_post_category","=","${e}"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${a}:${s}`}})).json();l.data&&(i.innerHTML+=l.data.map(g=>`<option value="${g.name}" data-display-name="${g.post_category_name}">${g.post_category_name}</option>`).join(""))}catch(d){console.error("Error fetching apps:",d)}}o.addEventListener("change",function(){const e=this.value;e==="Plugin and App related query"?_():h(),Array.from(n.options).forEach((d,l)=>{l!==0&&(d.style.display=e?"block":"none")})}),n.addEventListener("change",e=>{r(e.target.value),n.querySelector("option[value='']").disabled=!0}),i.addEventListener("change",()=>{i.querySelector("option[value='']").disabled=!0}),u(),h()});const q=document.getElementById("name1"),z=document.getElementById("company_name"),T=document.getElementById("email");let c=document.getElementById("name1_valid"),m=document.getElementById("company_valid"),p=document.getElementById("email_valid");const D=/^(?=(?:[^A-Za-z]*[A-Za-z]){2})(?![^\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,]*[\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,])\S+(?: \S+){0,2}$/,U=/^[A-Za-z0-9 ]+$/,N=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,H=/[a-zA-Z0-9-]+(\.[a-zA-Z]{2,})+([\/\w.-]*)*\/?/;let A=!1,b=!1,$=!1,R=!1,B=!1,E=!1,L=!1,C=!0;q.addEventListener("input",()=>{const t=q.value.trim();t===""?(c.classList.remove("hidden"),c.textContent="Please Enter Valid name"):D.test(t)?(c.classList.add("hidden"),c.textContent=""):(c.classList.remove("hidden"),c.textContent="Please Enter Valid name")});z.addEventListener("input",()=>{const t=z.value.trim();t===""?(m.classList.remove("hidden"),m.textContent="Please provide the requested information"):U.test(t)?(m.classList.add("hidden"),m.textContent=""):(m.classList.remove("hidden"),m.textContent="Please Enter Valid Company name")});T.addEventListener("input",()=>{const t=T.value.trim();t===""?(p.classList.remove("hidden"),p.textContent="Please provide the requested information"):N.test(t)?(p.classList.add("hidden"),p.textContent=""):(p.classList.remove("hidden"),p.textContent="Please Enter Valid Email")});const w=document.getElementById("store_url"),x=document.getElementById("store_url_valid");w.addEventListener("input",function(){const t=w.value.trim();t===""||H.test(t)?x.classList.add("hidden"):(x.classList.remove("hidden"),C=!1)});const S=document.getElementById("plugin_or_app_related_queries"),F=document.getElementById("platformSelect"),M=document.getElementById("appSelect"),P=document.getElementById("plugin_id_valid"),V=document.getElementById("platform_id_valid"),k=document.getElementById("app_id_valid");M.addEventListener("input",()=>{S.value==="Plugin and App related query"&&M.value===""?(k.classList.remove("hidden"),L=!1):(k.classList.add("hidden"),L=!0)});F.addEventListener("input",()=>{S.value==="Plugin and App related query"&&F.value===""?(V.classList.remove("hidden"),E=!1):(V.classList.add("hidden"),E=!0)});S.addEventListener("input",()=>{S.value===""?(P.classList.remove("hidden"),B=!1):(P.classList.add("hidden"),B=!0)});function K(){let t=q.value.trim(),a=z.value.trim(),s=T.value.trim();if(t===""?(c.classList.remove("hidden"),c.textContent="Please Enter Valid name",A=!1):D.test(t)?(c.classList.add("hidden"),c.textContent="",A=!0):(c.classList.remove("hidden"),c.textContent="Please Enter Valid name",A=!1),a===""?(m.classList.remove("hidden"),m.textContent="Please provide the requested information",b=!1):U.test(a)?(m.classList.add("hidden"),m.textContent="",b=!0):(m.classList.remove("hidden"),m.textContent="Please Enter Valid Company name",b=!1),s===""?(p.classList.remove("hidden"),p.textContent="Please provide the requested information",$=!1):N.test(s)?(p.classList.add("hidden"),p.textContent="",$=!0):(p.classList.remove("hidden"),p.textContent="Please Enter Valid Email",$=!1),S.value===""?(P.classList.remove("hidden"),B=!1):(P.classList.add("hidden"),B=!0),S.value==="Plugin and App related query"?(F.value===""?(V.classList.remove("hidden"),E=!1):(V.classList.add("hidden"),E=!0),M.value===""?(k.classList.remove("hidden"),L=!1):(k.classList.add("hidden"),L=!0)):(E=!0,L=!0),w!==null){const o=w.value.trim();o===""||H.test(o)?(x.classList.add("hidden"),C=!0):(x.classList.remove("hidden"),C=!1)}return A&&b&&$&&B&&E&&L&&C&&(R=!0),R}let v=[];document.getElementById("attach_file").addEventListener("change",function(t){let a=t.target.files,s=document.getElementById("file_error"),o=document.getElementById("file_list"),n=document.getElementById("attach_file_text"),i=["jpeg","jpg","png","pdf","txt","zip","zzip","mp4","docx","csv","webp"],f=0,y=[],h=[];o.innerHTML="";for(let e=0;e<a.length;e++){let d=a[e].name.split(".").pop().toLowerCase();i.includes(d)?v.push(a[e]):h.push(a[e].name)}if(h.length>0){s.textContent=`Invalid file types: ${h.join(", ")}. Allowed formats: ${i.join(", ")}`,t.target.value="";return}else s.textContent="";v.forEach(e=>{f+=e.size,y.push(e.name)});let _=25;if(f/(1024*1024)>_){s.textContent=`Total file size must be under ${_}MB.`,t.target.value="",v=[],n.textContent="Attach File";return}else s.textContent="";function u(e){v.splice(e,1),r()}function r(){o.innerHTML="",v.forEach((e,d)=>{let l=document.createElement("div");l.classList.add("file-item"),l.textContent=e.name;let g=document.createElement("button");g.textContent="x",g.classList.add("cancel-btn"),g.addEventListener("click",function(){u(d)}),l.appendChild(g),o.appendChild(l)})}r()});document.getElementById("cancel_file").addEventListener("click",function(){let t=document.getElementById("attach_file"),a=document.getElementById("file_list");t.value="",a.innerHTML="",document.getElementById("file_error").textContent="",v=[]});document.getElementById("form_id");function Z(t){const a=document.getElementById("success-popup"),s=document.getElementById("cancel_file"),o=document.getElementById("form_id");if(t.ok){a.classList.remove("hidden");const n=()=>{a.classList.add("hidden"),s.classList.add("hidden"),document.getElementById("attach_file_text").textContent="Attach File",document.getElementById("file_list").innerHTML="",o.reset(),location.reload()};document.getElementById("closePopup").addEventListener("click",n),setTimeout(n,3e3)}else console.error("Failed to create document.")}function O(){document.getElementById("loader").classList.remove("hidden")}function j(){document.getElementById("loader").classList.add("hidden")}async function G(t){if(t.preventDefault(),K()){O();const s="https://support.simprosys.com",o="c58178baf306cfa",n="51c0b9c774c0488";document.querySelector("#attach_file");let i=[];if(v.length>0){const u=v.map(async r=>{const e=new FormData;e.append("file",r),e.append("is_private",0);const d=await fetch(`${s}/api/method/upload_file`,{method:"POST",headers:{Authorization:`token ${o}:${n}`},body:e}),l=await d.json();if(d.ok&&l.message.file_url)return l.message.file_url;throw new Error("File upload failed: "+(l.message?.error||"Unknown error"))});try{i=await Promise.all(u)}catch(r){console.error("Upload error:",r),alert("File upload failed: "+r.message);return}}const f=document.querySelector("#platformSelect"),y=document.querySelector("#appSelect"),h=f.options[f.selectedIndex],_=y.options[y.selectedIndex],I={name1:document.querySelector("#name1").value,company_name:document.querySelector("#company_name").value,store_url:document.querySelector("#store_url").value,email:document.querySelector("#email").value,plugin_or_app_related_queries:document.querySelector("#plugin_or_app_related_queries").value,platform:h?h.getAttribute("data-display-name"):"",app:_?_.getAttribute("data-display-name"):"",additional_details:document.querySelector("#message").value};try{const u=await fetch(`${s}/api/resource/Support%20Simprosys%20Ticket`,{method:"POST",headers:{Authorization:`token ${o}:${n}`,"Content-Type":"application/json"},body:JSON.stringify(I)}),r=await u.json();if(u.ok){let e=r.data.name;await J(e,i),j(),Z(u),await Q(e)}else alert("Error: "+r.error)}catch(u){j(),console.error("Form submission error:",u),alert("Failed to submit ticket!")}}}async function J(t,a){const s="https://support.simprosys.com",o="c58178baf306cfa",n="51c0b9c774c0488";for(let i of a){const f={file_url:i,attached_to_doctype:"Support Simprosys Ticket",attached_to_name:t};try{await fetch(`${s}/api/resource/File`,{method:"POST",headers:{Authorization:`token ${o}:${n}`,"Content-Type":"application/json"},body:JSON.stringify(f)})}catch(y){console.error("Attachment error:",y)}}}async function Q(t){const a="https://support.simprosys.com",s="c58178baf306cfa",o="51c0b9c774c0488";try{const i=await(await fetch(`${a}/api/method/support_simprosys.support_simprosys.api.send_support_ticket_email?docname=${t}`,{method:"GET",headers:{Authorization:`token ${s}:${o}`}})).json()}catch(n){console.error("Email sending failed:",n)}}window.submitTicket=G;
