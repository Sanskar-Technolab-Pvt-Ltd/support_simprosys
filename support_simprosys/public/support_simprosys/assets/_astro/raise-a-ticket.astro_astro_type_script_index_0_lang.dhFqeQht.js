document.addEventListener("DOMContentLoaded",async function(){const e="http://127.0.0.1:8000",n="c58178baf306cfa",a="183cbe6e18ea543",o=document.getElementById("plugin_or_app_related_queries"),s=document.getElementById("platformSelect"),i=document.getElementById("appSelect"),f=s.nextElementSibling,y=i.nextElementSibling;function h(){s.style.display="none",i.style.display="none",y.style.display="none",f.style.display="none"}function g(){s.style.display="block",i.style.display="block",y.style.display="flex",f.style.display="flex"}function S(){Array.from(s.options).forEach((t,l)=>{l!==0&&(t.style.display="none")})}async function C(){try{const l=await(await fetch(`${e}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Platform"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${n}:${a}`}})).json();l.data&&(s.innerHTML+=l.data.map(d=>`<option value="${d.name}" data-display-name="${d.post_category_name}">${d.post_category_name}</option>`).join(""),S())}catch(t){console.error("Error fetching platforms:",t)}}async function r(t){if(i.innerHTML='<option value="" disabled selected>Select App</option>',!!t)try{const d=await(await fetch(`${e}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Category"],["parent_simprosys_post_category","=","${t}"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${n}:${a}`}})).json();d.data&&(i.innerHTML+=d.data.map(c=>`<option value="${c.name}" data-display-name="${c.post_category_name}">${c.post_category_name}</option>`).join(""))}catch(l){console.error("Error fetching apps:",l)}}o.addEventListener("change",function(){const t=this.value;t==="Plugin and App related query"?g():h(),Array.from(s.options).forEach((l,d)=>{d!==0&&(l.style.display=t?"block":"none")})}),s.addEventListener("change",t=>{r(t.target.value),s.querySelector("option[value='']").disabled=!0}),i.addEventListener("change",()=>{i.querySelector("option[value='']").disabled=!0}),C(),h()});const z=document.getElementById("name1"),q=document.getElementById("company_name"),M=document.getElementById("email");let u=document.getElementById("name1_valid"),m=document.getElementById("company_valid"),p=document.getElementById("email_valid");const P=/^(?=(?:[^A-Za-z]*[A-Za-z]){2})(?![^\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,]*[\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,])\S+(?: \S+){0,2}$/,N=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,H=/[a-zA-Z0-9-]+(\.[a-zA-Z]{2,})+([\/\w.-]*)*\/?/;let A=!1,b=!1,$=!1,D=!1,B=!1,v=!1,E=!1,I=!0;z.addEventListener("input",()=>{const e=z.value.trim();e===""?(u.classList.remove("hidden"),u.textContent="Please fill out this field"):P.test(e)?(u.classList.add("hidden"),u.textContent=""):(u.classList.remove("hidden"),u.textContent="Please Enter Valid name")});q.addEventListener("input",()=>{const e=q.value.trim();e===""?(m.classList.remove("hidden"),m.textContent="Please fill out this field"):P.test(e)?(m.classList.add("hidden"),m.textContent=""):(m.classList.remove("hidden"),m.textContent="Please Enter Valid Company name")});M.addEventListener("input",()=>{const e=M.value.trim();e===""?(p.classList.remove("hidden"),p.textContent="Please fill out this field"):N.test(e)?(p.classList.add("hidden"),p.textContent=""):(p.classList.remove("hidden"),p.textContent="Please Enter Valid Email")});const w=document.getElementById("store_url"),L=document.getElementById("store_url_valid");w.addEventListener("input",function(){const e=w.value.trim();e===""||H.test(e)?L.classList.add("hidden"):(L.classList.remove("hidden"),I=!1)});const x=document.getElementById("plugin_or_app_related_queries"),R=document.getElementById("platformSelect"),j=document.getElementById("appSelect"),T=document.getElementById("plugin_id_valid"),k=document.getElementById("platform_id_valid"),V=document.getElementById("app_id_valid");j.addEventListener("input",()=>{x.value==="Plugin and App related query"&&j.value===""?(V.classList.remove("hidden"),E=!1):(V.classList.add("hidden"),E=!0)});R.addEventListener("input",()=>{x.value==="Plugin and App related query"&&R.value===""?(k.classList.remove("hidden"),v=!1):(k.classList.add("hidden"),v=!0)});x.addEventListener("input",()=>{x.value===""?(T.classList.remove("hidden"),B=!1):(T.classList.add("hidden"),B=!0)});function K(){let e=z.value.trim(),n=q.value.trim(),a=M.value.trim();if(e===""?(u.classList.remove("hidden"),u.textContent="Please fill out this field",A=!1):P.test(e)?(u.classList.add("hidden"),u.textContent="",A=!0):(u.classList.remove("hidden"),u.textContent="Please Enter Valid name",A=!1),n===""?(m.classList.remove("hidden"),m.textContent="Please fill out this field",b=!1):P.test(n)?(m.classList.add("hidden"),m.textContent="",b=!0):(m.classList.remove("hidden"),m.textContent="Please Enter Valid Company name",b=!1),a===""?(p.classList.remove("hidden"),p.textContent="Please fill out this field",$=!1):N.test(a)?(p.classList.add("hidden"),p.textContent="",$=!0):(p.classList.remove("hidden"),p.textContent="Please Enter Valid Email",$=!1),x.value===""?(T.classList.remove("hidden"),B=!1):(T.classList.add("hidden"),B=!0),x.value==="Plugin and App related query"?(R.value===""?(k.classList.remove("hidden"),v=!1):(k.classList.add("hidden"),v=!0),j.value===""?(V.classList.remove("hidden"),E=!1):(V.classList.add("hidden"),E=!0)):(v=!0,E=!0),w!==null){const o=w.value.trim();o===""||H.test(o)?(L.classList.add("hidden"),I=!0):(L.classList.remove("hidden"),I=!1)}return A&&b&&$&&B&&v&&E&&F&&I&&(D=!0),D}let F=!0,_=[];document.getElementById("attach_file").addEventListener("change",function(e){let n=e.target.files,a=document.getElementById("file_error"),o=document.getElementById("file_list"),s=document.getElementById("attach_file_text"),i=["jpeg","jpg","png","pdf","txt","zip","zzip","mp4","docx","csv","webp"],f=0,y=[],h=[];o.innerHTML="";for(let t=0;t<n.length;t++){let l=n[t].name.split(".").pop().toLowerCase();i.includes(l)?_.push(n[t]):h.push(n[t].name)}if(h.length>0){a.textContent=`Invalid file types: ${h.join(", ")}. Allowed formats: ${i.join(", ")}`,e.target.value="";return}else a.textContent="";_.forEach(t=>{f+=t.size,y.push(t.name)});let g=25;if(f/(1024*1024)>g){a.textContent=`Total file size must be under ${g}MB.`,e.target.value="",_=[],F=!1,s.textContent="Attach File";return}else a.textContent="",F=!0;function C(t){_.splice(t,1),r()}function r(){o.innerHTML="",_.forEach((t,l)=>{let d=document.createElement("div");d.classList.add("file-item"),d.textContent=t.name;let c=document.createElement("button");c.textContent="x",c.classList.add("cancel-btn"),c.addEventListener("click",function(){C(l)}),d.appendChild(c),o.appendChild(d)})}r()});document.getElementById("cancel_file").addEventListener("click",function(){let e=document.getElementById("attach_file"),n=document.getElementById("file_list");e.value="",n.innerHTML="",document.getElementById("file_error").textContent="",_=[],F=!0});document.getElementById("form_id");function U(e){const n=document.getElementById("success-popup"),a=document.getElementById("form_id");let o=document.getElementById("cancel_file");e.ok?(n.classList.remove("hidden"),console.log("Ticket created successfully."),document.getElementById("closePopup").addEventListener("click",()=>{n.classList.add("hidden"),o.classList.add("hidden"),document.getElementById("attach_file_text").textContent="Attach File",document.getElementById("file_list").innerHTML="",a.reset()}),setTimeout(()=>{n.classList.add("hidden"),o.classList.add("hidden"),document.getElementById("attach_file_text").textContent="Attach File",document.getElementById("file_list").innerHTML="",a.reset()},3e3),e.status===100?(n.classList.remove("hidden"),console.log("Document created successfully.")):console.error("Failed to create document.")):console.error("Failed to create document.")}async function O(e){if(e.preventDefault(),K()){const a="http://127.0.0.1:8000",o="c58178baf306cfa",s="183cbe6e18ea543",i=document.querySelector("#attach_file");console.log("Called");let f=[];if(i.files.length>0)for(let r=0;r<i.files.length;r++){const t=i.files[r];console.log("File",t);const l=new FormData;l.append("file",t),l.append("is_private",0),console.log(l);try{console.log(l);const d=await fetch(`${a}/api/method/upload_file`,{method:"POST",headers:{Authorization:`token ${o}:${s}`},body:l}),c=await d.json();if(d.ok&&c.message.file_url)f.push(c.message.file_url),console.log("result"),console.log(c);else{alert("File upload failed: "+(c.message.error||"Unknown error"));return}}catch(d){console.error("File upload error:",d),alert("File upload failed!");return}}const y=document.querySelector("#platformSelect"),h=document.querySelector("#appSelect"),g=y.options[y.selectedIndex],S=h.options[h.selectedIndex],C={name1:document.querySelector("#name1").value,company_name:document.querySelector("#company_name").value,store_url:document.querySelector("#store_url").value,email:document.querySelector("#email").value,plugin_or_app_related_queries:document.querySelector("#plugin_or_app_related_queries").value,platform:g?g.getAttribute("data-display-name"):"",app:S?S.getAttribute("data-display-name"):"",additional_details:document.querySelector("#message").value};try{const r=await fetch(`${a}/api/resource/Support%20Simprosys%20Ticket`,{method:"POST",headers:{Authorization:`token ${o}:${s}`,"Content-Type":"application/json"},body:JSON.stringify(C)}),t=await r.json();if(r.ok){let l=t.data.name;console.log("Ticket Name",l),await Z(l,f),U(r),await G(l)}else alert("Error: "+t.error)}catch(r){console.error("Form submission error:",r),alert("Failed to submit ticket!")}}}async function Z(e,n){const a="http://127.0.0.1:8000",o="c58178baf306cfa",s="183cbe6e18ea543";console.log(`
Ticket Name`,e),console.log(`
File URL`,n);for(let i of n){const f={file_url:i,attached_to_doctype:"Support Simprosys Ticket",attached_to_name:e};try{await fetch(`${a}/api/resource/File`,{method:"POST",headers:{Authorization:`token ${o}:${s}`,"Content-Type":"application/json"},body:JSON.stringify(f)})}catch(y){console.error("Attachment error:",y)}}}async function G(e){const n="http://127.0.0.1:8000",a="c58178baf306cfa",o="183cbe6e18ea543";try{const s=await fetch(`${n}/api/method/support_simprosys.support_simprosys.api.send_support_ticket_email?docname=${e}`,{method:"GET",headers:{Authorization:`token ${a}:${o}`}});console.log("Email Response Status:",s.status);const i=await s.json();console.log("Email API response:",i)}catch(s){console.error("Email sending failed:",s)}}window.submitTicket=O;
