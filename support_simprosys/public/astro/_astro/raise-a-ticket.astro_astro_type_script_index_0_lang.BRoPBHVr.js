document.addEventListener("DOMContentLoaded",async function(){const t="http://127.0.0.1:8000",a="c58178baf306cfa",l="183cbe6e18ea543",s=document.getElementById("plugin_or_app_related_queries"),n=document.getElementById("platformSelect"),i=document.getElementById("appSelect"),f=n.nextElementSibling,y=i.nextElementSibling;function h(){n.style.display="none",i.style.display="none",y.style.display="none",f.style.display="none"}function v(){n.style.display="block",i.style.display="block",y.style.display="flex",f.style.display="flex"}function I(){Array.from(n.options).forEach((e,d)=>{d!==0&&(e.style.display="none")})}async function p(){try{const d=await(await fetch(`${t}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Platform"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${a}:${l}`}})).json();d.data&&(n.innerHTML+=d.data.map(o=>`<option value="${o.name}" data-display-name="${o.post_category_name}">${o.post_category_name}</option>`).join(""),I())}catch(e){console.error("Error fetching platforms:",e)}}async function r(e){if(i.innerHTML='<option value="" disabled selected>Select App</option>',!!e)try{const o=await(await fetch(`${t}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Category"],["parent_simprosys_post_category","=","${e}"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${a}:${l}`}})).json();o.data&&(i.innerHTML+=o.data.map(g=>`<option value="${g.name}" data-display-name="${g.post_category_name}">${g.post_category_name}</option>`).join(""))}catch(d){console.error("Error fetching apps:",d)}}s.addEventListener("change",function(){const e=this.value;e==="Plugin and App related query"?v():h(),Array.from(n.options).forEach((d,o)=>{o!==0&&(d.style.display=e?"block":"none")})}),n.addEventListener("change",e=>{r(e.target.value),n.querySelector("option[value='']").disabled=!0}),i.addEventListener("change",()=>{i.querySelector("option[value='']").disabled=!0}),p(),h()});const T=document.getElementById("name1"),V=document.getElementById("company_name"),q=document.getElementById("email");let c=document.getElementById("name1_valid"),m=document.getElementById("company_valid"),u=document.getElementById("email_valid");const D=/^(?=(?:[^A-Za-z]*[A-Za-z]){2})(?![^\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,]*[\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,])\S+(?: \S+){0,2}$/,U=/^[A-Za-z0-9 ]+$/,N=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,H=/[a-zA-Z0-9-]+(\.[a-zA-Z]{2,})+([\/\w.-]*)*\/?/;let A=!1,b=!1,$=!1,R=!1,B=!1,E=!1,L=!1,C=!0;T.addEventListener("input",()=>{const t=T.value.trim();t===""?(c.classList.remove("hidden"),c.textContent="Please fill out this field"):D.test(t)?(c.classList.add("hidden"),c.textContent=""):(c.classList.remove("hidden"),c.textContent="Please Enter Valid name")});V.addEventListener("input",()=>{const t=V.value.trim();t===""?(m.classList.remove("hidden"),m.textContent="Please fill out this field"):U.test(t)?(m.classList.add("hidden"),m.textContent=""):(m.classList.remove("hidden"),m.textContent="Please Enter Valid Company name")});q.addEventListener("input",()=>{const t=q.value.trim();t===""?(u.classList.remove("hidden"),u.textContent="Please fill out this field"):N.test(t)?(u.classList.add("hidden"),u.textContent=""):(u.classList.remove("hidden"),u.textContent="Please Enter Valid Email")});const w=document.getElementById("store_url"),x=document.getElementById("store_url_valid");w.addEventListener("input",function(){const t=w.value.trim();t===""||H.test(t)?x.classList.add("hidden"):(x.classList.remove("hidden"),C=!1)});const S=document.getElementById("plugin_or_app_related_queries"),F=document.getElementById("platformSelect"),M=document.getElementById("appSelect"),P=document.getElementById("plugin_id_valid"),k=document.getElementById("platform_id_valid"),z=document.getElementById("app_id_valid");M.addEventListener("input",()=>{S.value==="Plugin and App related query"&&M.value===""?(z.classList.remove("hidden"),L=!1):(z.classList.add("hidden"),L=!0)});F.addEventListener("input",()=>{S.value==="Plugin and App related query"&&F.value===""?(k.classList.remove("hidden"),E=!1):(k.classList.add("hidden"),E=!0)});S.addEventListener("input",()=>{S.value===""?(P.classList.remove("hidden"),B=!1):(P.classList.add("hidden"),B=!0)});function K(){let t=T.value.trim(),a=V.value.trim(),l=q.value.trim();if(t===""?(c.classList.remove("hidden"),c.textContent="Please fill out this field",A=!1):D.test(t)?(c.classList.add("hidden"),c.textContent="",A=!0):(c.classList.remove("hidden"),c.textContent="Please Enter Valid name",A=!1),a===""?(m.classList.remove("hidden"),m.textContent="Please fill out this field",b=!1):U.test(a)?(m.classList.add("hidden"),m.textContent="",b=!0):(m.classList.remove("hidden"),m.textContent="Please Enter Valid Company name",b=!1),l===""?(u.classList.remove("hidden"),u.textContent="Please fill out this field",$=!1):N.test(l)?(u.classList.add("hidden"),u.textContent="",$=!0):(u.classList.remove("hidden"),u.textContent="Please Enter Valid Email",$=!1),S.value===""?(P.classList.remove("hidden"),B=!1):(P.classList.add("hidden"),B=!0),S.value==="Plugin and App related query"?(F.value===""?(k.classList.remove("hidden"),E=!1):(k.classList.add("hidden"),E=!0),M.value===""?(z.classList.remove("hidden"),L=!1):(z.classList.add("hidden"),L=!0)):(E=!0,L=!0),w!==null){const s=w.value.trim();s===""||H.test(s)?(x.classList.add("hidden"),C=!0):(x.classList.remove("hidden"),C=!1)}return A&&b&&$&&B&&E&&L&&C&&(R=!0),R}let _=[];document.getElementById("attach_file").addEventListener("change",function(t){let a=t.target.files,l=document.getElementById("file_error"),s=document.getElementById("file_list"),n=document.getElementById("attach_file_text"),i=["jpeg","jpg","png","pdf","txt","zip","zzip","mp4","docx","csv","webp"],f=0,y=[],h=[];s.innerHTML="";for(let e=0;e<a.length;e++){let d=a[e].name.split(".").pop().toLowerCase();i.includes(d)?_.push(a[e]):h.push(a[e].name)}if(h.length>0){l.textContent=`Invalid file types: ${h.join(", ")}. Allowed formats: ${i.join(", ")}`,t.target.value="";return}else l.textContent="";_.forEach(e=>{f+=e.size,y.push(e.name)});let v=25;if(f/(1024*1024)>v){l.textContent=`Total file size must be under ${v}MB.`,t.target.value="",_=[],n.textContent="Attach File";return}else l.textContent="";function p(e){_.splice(e,1),r()}function r(){s.innerHTML="",_.forEach((e,d)=>{let o=document.createElement("div");o.classList.add("file-item"),o.textContent=e.name;let g=document.createElement("button");g.textContent="x",g.classList.add("cancel-btn"),g.addEventListener("click",function(){p(d)}),o.appendChild(g),s.appendChild(o)})}r()});document.getElementById("cancel_file").addEventListener("click",function(){let t=document.getElementById("attach_file"),a=document.getElementById("file_list");t.value="",a.innerHTML="",document.getElementById("file_error").textContent="",_=[]});document.getElementById("form_id");function Z(t){const a=document.getElementById("success-popup"),l=document.getElementById("cancel_file"),s=document.getElementById("form_id");if(t.ok){a.classList.remove("hidden");const n=()=>{a.classList.add("hidden"),l.classList.add("hidden"),document.getElementById("attach_file_text").textContent="Attach File",document.getElementById("file_list").innerHTML="",s.reset(),location.reload()};document.getElementById("closePopup").addEventListener("click",n),setTimeout(n,3e3)}else console.error("Failed to create document.")}function O(){document.getElementById("loader").classList.remove("hidden")}function j(){document.getElementById("loader").classList.add("hidden")}async function G(t){if(t.preventDefault(),K()){O();const l="http://127.0.0.1:8000",s="c58178baf306cfa",n="183cbe6e18ea543";document.querySelector("#attach_file");let i=[];if(_.length>0){const p=_.map(async r=>{const e=new FormData;e.append("file",r),e.append("is_private",0);const d=await fetch(`${l}/api/method/upload_file`,{method:"POST",headers:{Authorization:`token ${s}:${n}`},body:e}),o=await d.json();if(d.ok&&o.message.file_url)return o.message.file_url;throw new Error("File upload failed: "+(o.message?.error||"Unknown error"))});try{i=await Promise.all(p)}catch(r){console.error("Upload error:",r),alert("File upload failed: "+r.message);return}}const f=document.querySelector("#platformSelect"),y=document.querySelector("#appSelect"),h=f.options[f.selectedIndex],v=y.options[y.selectedIndex],I={name1:document.querySelector("#name1").value,company_name:document.querySelector("#company_name").value,store_url:document.querySelector("#store_url").value,email:document.querySelector("#email").value,plugin_or_app_related_queries:document.querySelector("#plugin_or_app_related_queries").value,platform:h?h.getAttribute("data-display-name"):"",app:v?v.getAttribute("data-display-name"):"",additional_details:document.querySelector("#message").value};try{const p=await fetch(`${l}/api/resource/Support%20Simprosys%20Ticket`,{method:"POST",headers:{Authorization:`token ${s}:${n}`,"Content-Type":"application/json"},body:JSON.stringify(I)}),r=await p.json();if(p.ok){let e=r.data.name;await J(e,i),j(),Z(p),await Q(e)}else alert("Error: "+r.error)}catch(p){j(),console.error("Form submission error:",p),alert("Failed to submit ticket!")}}}async function J(t,a){const l="http://127.0.0.1:8000",s="c58178baf306cfa",n="183cbe6e18ea543";for(let i of a){const f={file_url:i,attached_to_doctype:"Support Simprosys Ticket",attached_to_name:t};try{await fetch(`${l}/api/resource/File`,{method:"POST",headers:{Authorization:`token ${s}:${n}`,"Content-Type":"application/json"},body:JSON.stringify(f)})}catch(y){console.error("Attachment error:",y)}}}async function Q(t){const a="http://127.0.0.1:8000",l="c58178baf306cfa",s="183cbe6e18ea543";try{const i=await(await fetch(`${a}/api/method/support_simprosys.support_simprosys.api.send_support_ticket_email?docname=${t}`,{method:"GET",headers:{Authorization:`token ${l}:${s}`}})).json()}catch(n){console.error("Email sending failed:",n)}}window.submitTicket=G;
